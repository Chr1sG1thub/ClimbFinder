<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climb Finder</title>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.3.1/turf.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #fileInput { margin: 20px 0; }
        #results { margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 5px; }
        #climbs { margin-top: 20px; }
        .climb { background: #d4edda; padding: 10px; margin: 5px 0; border-radius: 4px; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; white-space: pre-wrap; font-size: 0.9em; }
        button { padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a87; }
        .error { color: red; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>Climb Finder</h1>
    <p>Upload GPX → Parse trackpoints → Find climbs (Fiets rating ≥100m @10%).</p>
    <input type="file" id="fileInput" accept=".gpx" />
    <button onclick="analyzeGPX()">Find Climbs</button>
    
    <div id="results" style="display: none;">
        <h2>Route Stats</h2>
        <p><strong>Total Length:</strong> <span id="length"></span> km</p>
        <p><strong>Trackpoints:</strong> <span id="pointCount"></span></p>
        <h3>First 10 Trackpoints:</h3>
        <pre id="trackpoints"></pre>
        
        <div id="climbs">
            <h2>Detected Climbs</h2>
            <p id="climbCount">No climbs found</p>
            <table id="climbsTable">
                <thead><tr><th>#</th><th>Start Pt</th><th>End Pt</th><th>Gain (m)</th><th>Dist (km)</th><th>Gradient (%)</th><th>Fiets Rating</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div id="error" class="error" style="display: none;"></div>

    <script>
        // [Keep all your findClimbs, climbRating, simplifyProfile, uniq, haversineDistance, parseGPX functions exactly as-is]

        // Enhanced analyzeGPX with climb display
        function analyzeGPX() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('error');
            const tbody = document.querySelector('#climbsTable tbody');

            resultsDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            tbody.innerHTML = '';

            if (!file) {
                showError('Please select a GPX file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let trackpoints = parseGPX(e.target.result);
                    
                    // Filter points with elevation
                    trackpoints = trackpoints.filter(p => p.ele !== null && !isNaN(p.ele));
                    if (trackpoints.length < 10) throw new Error('Insufficient points with elevation data');

                    // Calculate total length for courseDistance
                    let totalLength = 0;
                    for (let i = 1; i < trackpoints.length; i++) {
                        totalLength += haversineDistance(trackpoints[i-1], trackpoints[i]);
                    }

                    // Find climbs using defaults
                    const climbs = findClimbs({ 
                        points: trackpoints,
                        courseDistance: totalLength
                    });

                    // Display results
                    document.getElementById('length').textContent = totalLength.toFixed(2);
                    document.getElementById('pointCount').textContent = trackpoints.length.toLocaleString();
                    document.getElementById('trackpoints').textContent = JSON.stringify(
                        trackpoints.slice(0, 10), null, 2
                    );

                    // Populate climbs table
                    const climbCountEl = document.getElementById('climbCount');
                    if (climbs.length === 0) {
                        climbCountEl.textContent = 'No climbs found (≥100m @10%)';
                    } else {
                        climbCountEl.textContent = `${climbs.length} climb(s) found`;
                        climbs.forEach((climb, idx) => {
                            const startPt = trackpoints[climb[0]];
                            const endPt = trackpoints[climb[1]];
                            const gain = endPt.ele - startPt.ele;
                            const segPoints = trackpoints.slice(climb[0], climb[1] + 1);
                            const segDist = segPoints.reduce((sum, p, i) => 
                                i > 0 ? sum + haversineDistance(segPoints[i-1], p) : sum, 0);
                            const gradient = (gain / (segDist * 1000)) * 100;
                            const rating = climbRating({ points: segPoints });

                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${idx + 1}</td>
                                <td>${climb[0]} (${startPt.ele.toFixed(0)}m)</td>
                                <td>${climb[1]} (${endPt.ele.toFixed(0)}m)</td>
                                <td>${gain.toFixed(0)}</td>
                                <td>${segDist.toFixed(2)}</td>
                                <td>${gradient.toFixed(1)}%</td>
                                <td>${rating.toFixed(0)}</td>
                            `;
                        });
                    }

                    resultsDiv.style.display = 'block';
                    console.log('Climbs:', climbs);  // Debug
                } catch (err) {
                    showError(err.message);
                }
            };
            reader.onerror = () => showError('Failed to read file');
            reader.readAsText(file);
        }

        function showError(msg) {
            document.getElementById('error').textContent = msg;
            document.getElementById('error').style.display = 'block';
        }
    </script>
</body>
</html>
